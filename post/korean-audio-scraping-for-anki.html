<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Scraping korean audio fragments for Anki cards - Laurens' geeky adventures</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.laurens.xyz/post/korean-audio-scraping-for-anki.html">

        <meta name="author" content="Laurens" />
        <meta name="keywords" content="Anki,Korean,web,scraping,Python" />
        <meta name="description" content="Besides programming, I am also quite fond of the Korean language. One of the apps I use to study korean is Anki. Anki is a program that enables people to remember information efficiently using a spaced repetition algorithm. Anki is definitely not a sexy app by any means, especially compared ..." />

        <meta property="og:site_name" content="Laurens' geeky adventures" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Scraping korean audio fragments for Anki cards"/>
        <meta property="og:url" content="https://blog.laurens.xyz/post/korean-audio-scraping-for-anki.html"/>
        <meta property="og:description" content="Besides programming, I am also quite fond of the Korean language. One of the apps I use to study korean is Anki. Anki is a program that enables people to remember information efficiently using a spaced repetition algorithm. Anki is definitely not a sexy app by any means, especially compared ..."/>
        <meta property="article:published_time" content="2016-05-22" />
            <meta property="article:section" content="2016" />
            <meta property="article:tag" content="Anki" />
            <meta property="article:tag" content="Korean" />
            <meta property="article:tag" content="web" />
            <meta property="article:tag" content="scraping" />
            <meta property="article:tag" content="Python" />
            <meta property="article:author" content="Laurens" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.laurens.xyz/theme/css/bootstrap.yeti.min.css" type="text/css"/>
    <link href="https://blog.laurens.xyz/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.laurens.xyz/theme/css/pygments/zenburn.css" rel="stylesheet">
    <link href="https://blog.laurens.xyz/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.laurens.xyz/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.laurens.xyz/" class="navbar-brand">
Laurens' geeky adventures            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li ><a href="https://blog.laurens.xyz/tags.html">Tags</a></li>
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="https://blog.laurens.xyz/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.laurens.xyz/post/korean-audio-scraping-for-anki.html"
                       rel="bookmark"
                       title="Permalink to Scraping korean audio fragments for Anki cards">
                        Scraping korean audio fragments for Anki cards
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-05-22T12:44:00+02:00"> 22-05-2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://blog.laurens.xyz/tags/anki.html">Anki</a>
        /
	<a href="https://blog.laurens.xyz/tags/korean.html">Korean</a>
        /
	<a href="https://blog.laurens.xyz/tags/web.html">web</a>
        /
	<a href="https://blog.laurens.xyz/tags/scraping.html">scraping</a>
        /
	<a href="https://blog.laurens.xyz/tags/python.html">Python</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Besides programming, I am also quite fond of the Korean language. One of the apps I
use to study korean is <a href="www.ankisrs.net">Anki</a>. Anki is a program that enables people
to remember information efficiently using a spaced repetition algorithm. Anki is definitely
not a sexy app by any means, especially compared to the webbased <a href="www.memrise.com">Memrise</a>,
but it provides a huge amount of control for the end-user. I have come to love Anki for
this very reason.</p>
<p>Anki also provides an easy distribution system where people can share their <em>decks</em>. If there
is any language and language course that you are taking, there is probably someone out
there who did it before you and shared an Anki deck for it. Finding quality decks however is
rather hard. Luckily, for the Korean language I found an excellent <a href="https://ankiweb.net/shared/info/4066961604">Korean vocabulary deck
by Evita</a>. For what it's worth, I like to
give credits to her for making my studies so much easier. The deck contains thousands of the
most common words in decreasing order. There is a decent amount of sounds added to,
which really helps with getting the pronunciation right. Unfortunately, too often I found
that sounds are missing. I really wanted to have a more complete set of sound fragments to
improve my studies so decided to write a little script in Python to do this for me.
I will briefly guide you through the steps that are needed to run this script.</p>
<h1>Scraping sound fragments and adding it to your deck</h1>
<p>First, obtain the <a href="https://ankiweb.net/shared/info/4066961604">Korean vocabulary deck by Evita</a> to operate on.
<strong>If you already have made progress in this deck and do not want to lose it</strong>,
it is also possible to export this deck from your own Anki environment. Make sure to include
the progress whilst exporting the <code>.apkg</code> file. Copy this file to a empty directory,
for example in <code>C:\tmp\</code>, and rename it to <code>in.apkg</code>.</p>
<p>The python 3 script at the bottom of this page will scrape the dictionary pages of
<a href="www.naver.com">Naver</a> (preferred) or <a href="www.daum.net">Daum</a>. Put this script in the working directory, in my case <code>C:\tmp\script.py</code>.
Then open a command window in that folder (<code>shift</code> + <code>right click</code>, then choose <em>open command
window here</em> if you are on Windows). The following command will start the script, make sure
that python 3 is installed:</p>
<div class="highlight"><pre><span></span>python script.py
</pre></div>


<p>Executing the script will take a few hours. Please wait for it to finish. But no worries,
the script can be interrupted. Simply run the script again to continue where it left off.
In the end, a new file should have appeared named <code>out.apkg</code>. This is the new deck,
containing all your originals cards and progress of you Korean vocabulary deck (by <em>Evita</em>),
and extended to have more sound fragments. In total, I found that this script adds <strong>4130 new sound fragments</strong>, making a total of 4823 notes with audio and just around 90 that still lack audio. That's quite a significant improvement!</p>
<h1>Can't you just give me your deck?</h1>
<p>You clearly see the code and think, should I really run this and set this all up? No,
I understand completely as true programmers are inherently lazy (hence they let programs
do their work). I have simply uploaded a fresh copy of the original deck as stated above,
on which my script did all the heavy lifting. You can simply <a href="https://blog.laurens.xyz/files/Korean vocabulary by Evita and Laurens.apkg">download it here</a>. I hope this extended
deck helps you as much as it did for me!</p>
<h3>The python script</h3>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span> <span class="kn">as</span> <span class="nn">lite</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">html</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span><span class="p">,</span> <span class="n">make_archive</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="c1"># Do not forget to set the working directory. A sdubdirectory named &#39;download&#39; is expected to be in it.</span>
<span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="c1"># relative path</span>


<span class="k">def</span> <span class="nf">loop_anki_cards</span><span class="p">():</span>
    <span class="n">copyfile</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;unzip</span><span class="se">\\</span><span class="s1">collection.anki2&#39;</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;download</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;collection.anki2&#39;</span><span class="p">)</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">lite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;download</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;collection.anki2&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">con</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id,flds FROM notes&quot;</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x1f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wordE</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Attempting to fetch word: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wordE</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
                <span class="n">fetch</span> <span class="o">=</span> <span class="n">fetch_mp3</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fetch</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[sound:_kr_voc_evita_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;.mp3]&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># rename the filenames of sound fragmetns to have a prefix, to stop name collision errors with other decks</span>
                <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_kr_voc_evita_&#39;</span> <span class="o">+</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">:]</span>

            <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1f</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>

            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE notes SET flds = &#39;&quot;</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;&#39; WHERE id = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">success</span>


<span class="k">def</span> <span class="nf">fetch_mp3</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;_kr_voc_evita_&#39;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;.mp3&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;download</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">):</span>
        <span class="c1"># File already exists, so no need to download again</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Sound fragment already exists&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">fetch_mp3_url</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;download</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;xb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="k">del</span> <span class="nb">file</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Succesfully saved word&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">filename</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">fetch_mp3_url</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="c1"># First attempt naver, if unable to extract sound, try daum.</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">naver_url</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">daum_url</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">url</span>


<span class="k">def</span> <span class="nf">daum_url</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="c1">############</span>
    <span class="c1"># ATTEMPT 1: Standard Daum</span>
    <span class="c1">############</span>
    <span class="n">pre_url</span> <span class="o">=</span> <span class="s1">&#39;http://alldic.daum.net/search.do?q=&#39;</span>
    <span class="n">post_url</span> <span class="o">=</span> <span class="s1">&#39;&amp;dic=kor&#39;</span>

    <span class="c1"># get html and parse it into a searchable tree for python</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pre_url</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="n">post_url</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># find the mp3 url file javascript code using a XPath</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@id=&quot;mArticle&quot;]/div[1]/div[2]/div[2]/div[1]/div/strong/span/a/@href&#39;</span><span class="p">)</span>

    <span class="c1"># If succesfully found, extract the sound url from the javascript event between the quotes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mp3</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Found sound fragment on Daum&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mp3</span>

    <span class="c1">############</span>
    <span class="c1"># ATTEMPT 2: Daum forwarded</span>
    <span class="c1">############</span>
    <span class="c1"># If we get here, it means we couldn&#39;t find the sound url because this is a redirecting page. Follow the redirect:</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.+has_exact_redirect&#39;, &#39;(.*)_(.*)&#39;.*&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://alldic.daum.net/word/view.do?wordid=</span><span class="si">%s</span><span class="s1">&amp;q=</span><span class="si">%s</span><span class="s1">&amp;supid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">regex</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">word</span><span class="p">,</span> <span class="n">regex</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@id=&quot;mSub&quot;]/div/div[2]/div/em/span[2]/span/a[1]/@href&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mp3</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Followed redirect and found sound fragment on Daum&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mp3</span>
    <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">naver_url</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://dic.naver.com/search.nhn?dicQuery={}&amp;query={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

    <span class="c1"># get html and parse it into a searchable tree for python</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># find the mp3 url file javascript code using a XPath</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//ul[contains(@class,&quot;lst_krdic&quot;)]/li[</span><span class="si">%d</span><span class="s1">]/p&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">):</span>
        <span class="c1"># Check for each entry what is the precise word</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//ul[contains(@class,&quot;lst_krdic&quot;)]/li[</span><span class="si">%d</span><span class="s1">]/p/a/span&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;string()&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="n">word</span><span class="p">:</span>
                <span class="c1"># We got a word that matches the one we want. Try and find a audio link</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//ul[contains(@class,&quot;lst_krdic&quot;)]/li[</span><span class="si">%d</span><span class="s1">]/p/a[2]/@playlist&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># we found a playlist, return the link and exit the function</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; Found sound fragment on Naver&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">edit_media_file</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;unzip</span><span class="se">\\</span><span class="s1">media&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Moving file...({}/{})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;_kr_voc_evita_&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span>
        <span class="n">copyfile</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;unzip</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;download</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">download&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">]:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;download</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;download</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;download</span><span class="se">\\</span><span class="s1">media&#39;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prepare_dirs</span><span class="p">():</span>
    <span class="c1"># make directories</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;unzip&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;unzip&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s1">&#39;in.apkg&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
        <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;unzip&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">zipdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">ziph</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
    <span class="c1"># ziph is zipfile handle</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">ziph</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nb">file</span><span class="p">),</span> <span class="nb">file</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">prepare_dirs</span><span class="p">()</span>
    <span class="n">addedcount</span> <span class="o">=</span> <span class="n">loop_anki_cards</span><span class="p">()</span>
    <span class="n">edit_media_file</span><span class="p">()</span>
    <span class="n">zipdir</span><span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s2">&quot;download</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;out.apkg&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;SUCCESFULLY ADDED {} SOUND FRAGMENTS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addedcount</span><span class="p">))</span>
</pre></div>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'iilaurens'; // required: replace example with your forum shortname

                    var disqus_identifier = 'korean-audio-scraping-for-anki';
                var disqus_url = 'https://blog.laurens.xyz/post/korean-audio-scraping-for-anki.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Laurens
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.laurens.xyz/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.laurens.xyz/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.laurens.xyz/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'iilaurens'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-77190701-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>